<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>创二病人-管床医生分配系统</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; margin: 20px; background-color: #f9fafb; color: #333; }
    h2 { margin-top: 30px; color: #1f2937; padding-bottom: 5px; border-bottom: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; background-color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: center; min-width: 80px; font-size: 14px; }
    th { background-color: #3b82f6; color: white; font-weight: 600; }
    tr:nth-child(even) td { background-color: #f3f4f6; }
    tr:hover td { background-color: #e0f2fe; }
    .discharged { color: #9ca3af; text-decoration: line-through; }
    .placeholder { color: #d1d5db; }
    input[type="text"], input[list], select { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; outline: none; font-size: 14px; width: 180px; transition: 0.2s; }
    input[type="text"]:focus, input[list]:focus, select:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
    button { padding: 6px 12px; border: none; border-radius: 6px; background-color: #3b82f6; color: white; cursor: pointer; font-size: 14px; transition: 0.2s; margin:2px; }
    button:hover { background-color: #2563eb; }
    .controls { margin-top: 10px; display: flex; gap: 15px; align-items: center; font-size: 14px; }
    .controls input[type="radio"] { margin-right: 5px; }
    .patient-title { margin-top: 25px; }
    .patient-title span { color: #555; font-weight: normal; margin-left: 10px; }
    .custom-order { margin-top:10px; display:flex; align-items:center; gap:10px; }
    .custom-order input { flex:1; padding:6px 8px; border:1px solid #d1d5db; border-radius:6px; }
  </style>
</head>
<body>
  <h2>创二病人-管床分配系统</h2>

  <!-- 入院操作 -->
  <div style="margin-top:15px;">
    <input type="text" id="patientName" placeholder="输入病人姓名">
    <input list="doctorListDatalist" id="doctorName" placeholder="选择或输入管床医生姓名">
    <datalist id="doctorListDatalist"></datalist>
    <button onclick="admitPatient()">入院</button>
  </div>

  <!-- 汇总表 -->
  <div class="patient-title">
    <h2 style="display: inline; margin:0;">汇总表</h2>
    <span>(手动设置顺序)</span>
  </div>

  <!-- 自定义医生顺序输入框 -->
  <div class="custom-order">
    <input type="text" id="customDoctorOrder" placeholder="输入医生顺序，用 - 分割">
    <button onclick="setCustomDoctorOrder()">设置顺序</button>
  </div>

  <div class="controls">
    <label><input type="radio" name="viewMode" value="current" checked onchange="renderSummary()"> 当前在院</label>
    <label><input type="radio" name="viewMode" value="all" onchange="renderSummary()"> 所有病人</label>
  </div>
  <table id="summaryTable"></table>

  <!-- 病人列表 -->
  <div class="patient-title">
    <h2 style="display: inline; margin:0;">病人列表</h2>
    <span>(拖动顺序为收治顺序)</span>
  </div>
  <table id="patientTable"></table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCe5seH8kOkGOfquiUYvFHz2bvcDssWGMs",
      authDomain: "patient-reminder-95c8d.firebaseapp.com",
      databaseURL: "https://patient-reminder-95c8d-default-rtdb.firebaseio.com",
      projectId: "patient-reminder-95c8d",
      storageBucket: "patient-reminder-95c8d.firebasestorage.app",
      messagingSenderId: "726326025491",
      appId: "1:726326025491:web:6b77dce30f7c0f9ddc4ee6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const patientsRef = ref(db, 'patients');
    const doctorOrderRef = ref(db, 'doctorOrder');

    let patients = [];
    let doctorOrder = [];
    let doctorOrderLoaded = false;

    // 监听医生顺序
    onValue(doctorOrderRef, snap => {
      const cloudOrder = snap.val();
      if (cloudOrder && cloudOrder.length) {
        doctorOrder = cloudOrder;
        doctorOrderLoaded = true;
        renderSummary();
      }
    });

    // 监听病人数据
    onValue(patientsRef, snap => {
      patients = snap.val() || [];
      initDoctorOrder(); // 补充新医生
      renderPatients();
      renderSummary();
      renderDoctorDatalist();
    });

    function admitPatient() {
      const name = document.getElementById("patientName").value.trim();
      let doctor = document.getElementById("doctorName").value.trim();
      if (!name || !doctor) return;
      patients.push({ name, doctor, discharged: false, timestamp: Date.now() });
      set(patientsRef, patients);
      document.getElementById("patientName").value = "";
      document.getElementById("doctorName").value = "";
    }

    function dischargePatient(index) {
      patients[index].discharged = true;
      set(patientsRef, patients);
    }

    function deletePatient(index) {
      if (confirm(`确认删除病人：${patients[index].name}？`)) {
        patients.splice(index, 1);
        set(patientsRef, patients);
      }
    }

    function reassignDoctor(index) {
      const input = document.getElementById(`reassignInput-${index}`);
      const newDoctor = input.value.trim();
      if (newDoctor) {
        patients[index].doctor = newDoctor;
        set(patientsRef, patients);
        if (!doctorOrder.includes(newDoctor)) {
          doctorOrder.push(newDoctor);
          set(doctorOrderRef, doctorOrder);
        }
      }
    }

    function updatePatientName(index, newName) {
      if (!newName.trim()) return;
      patients[index].name = newName.trim();
      set(patientsRef, patients);
    }

    function initDoctorOrder() {
      const uniqueDoctors = Array.from(new Set(patients.map(p => p.doctor)));
      if (doctorOrderLoaded) {
        // 云端顺序已加载，补充新医生
        uniqueDoctors.forEach(doc => { if (!doctorOrder.includes(doc)) doctorOrder.push(doc); });
        set(doctorOrderRef, doctorOrder);
      } else {
        // 云端没有顺序，初始化默认顺序
        doctorOrder = uniqueDoctors;
        set(doctorOrderRef, doctorOrder);
        doctorOrderLoaded = true;
      }
    }

    function setCustomDoctorOrder() {
      const input = document.getElementById("customDoctorOrder").value.trim();
      if (!input) return;
      const newOrder = input.split("-").map(s => s.trim()).filter(Boolean);
      const allDoctors = Array.from(new Set(patients.map(p => p.doctor)));
      const finalOrder = newOrder.concat(allDoctors.filter(d => !newOrder.includes(d)));
      doctorOrder = finalOrder;
      set(doctorOrderRef, doctorOrder);
      renderSummary();
    }

    function renderPatients() {
      const table = document.getElementById("patientTable");
      table.innerHTML = "<tr><th>姓名</th><th>管床医生</th><th>操作</th></tr>";

      patients.forEach((p, i) => {
        const row = document.createElement("tr");
        row.dataset.index = i;
        row.innerHTML = `
          <td class="${p.discharged ? 'discharged' : ''}">
            <input type="text" value="${p.name}" ${p.discharged ? 'disabled' : ''} 
                   onblur="updatePatientName(${i}, this.value)">
          </td>
          <td>
            <input list="doctorListDatalist" id="reassignInput-${i}" value="${p.doctor}" ${p.discharged ? 'disabled' : ''} onblur="reassignDoctor(${i})">
          </td>
          <td>
            ${!p.discharged ? `<button onclick="dischargePatient(${i})">出院</button>` : ''} 
            <button onclick="deletePatient(${i})">删除</button>
          </td>
        `;
        table.appendChild(row);
      });

      addPatientDragAndDrop();
    }

    function addPatientDragAndDrop() {
      let draggedIndex = null;
      const rows = document.querySelectorAll("#patientTable tr:not(:first-child)");
      rows.forEach(row => {
        row.draggable = true;
        row.addEventListener("dragstart", e => {
          draggedIndex = parseInt(row.dataset.index);
          e.dataTransfer.effectAllowed = "move";
        });
        row.addEventListener("dragover", e => e.preventDefault());
        row.addEventListener("drop", e => {
          e.preventDefault();
          const targetIndex = parseInt(row.dataset.index);
          if (draggedIndex === null || draggedIndex === targetIndex) return;
          const movedItem = patients.splice(draggedIndex, 1)[0];
          patients.splice(targetIndex, 0, movedItem);
          set(patientsRef, patients);
          draggedIndex = null;
        });
      });
    }

    function renderSummary() {
      const table = document.getElementById("summaryTable");
      table.innerHTML = "";
      if (!patients.length) return;

      const viewMode = document.querySelector('input[name="viewMode"]:checked').value;
      const doctorsFromPatients = Array.from(new Set(patients.map(p => p.doctor)));
      doctorsFromPatients.forEach(doc => { if (!doctorOrder.includes(doc)) doctorOrder.push(doc); });
      const doctors = doctorOrder.slice();

      const doctorPatients = doctors.map(doc =>
        patients.filter(p => p.doctor === doc).map(p => {
          if (viewMode === "current") return !p.discharged ? p.name : null;
          else return p.discharged ? `${p.name}(已出院)` : p.name;
        }).filter(Boolean)
      );

      const maxLen = Math.max(...doctorPatients.map(arr => arr.length), 0);

      const header = document.createElement("tr");
      doctors.forEach(doc => {
        const th = document.createElement("th");
        th.textContent = doc;
        header.appendChild(th);
      });
      table.appendChild(header);

      for (let i = 0; i < maxLen; i++) {
        const row = document.createElement("tr");
        doctors.forEach((doc, d) => {
          const td = document.createElement("td");
          td.textContent = doctorPatients[d][i] || " ";
          if (td.textContent === " ") td.className = "placeholder";
          row.appendChild(td);
        });
        table.appendChild(row);
      }
    }

    function renderDoctorDatalist() {
      const datalist = document.getElementById("doctorListDatalist");
      datalist.innerHTML = "";
      const doctorSet = new Set(patients.map(p => p.doctor));
      Array.from(doctorSet).forEach(doc => {
        const option = document.createElement("option");
        option.value = doc;
        datalist.appendChild(option);
      });
    }

    window.admitPatient = admitPatient;
    window.dischargePatient = dischargePatient;
    window.deletePatient = deletePatient;
    window.reassignDoctor = reassignDoctor;
    window.updatePatientName = updatePatientName;
    window.renderSummary = renderSummary;
    window.setCustomDoctorOrder = setCustomDoctorOrder;
  </script>
</body>
</html>
