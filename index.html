<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>病人管理系统</title>
<style>
body { font-family: "Segoe UI", sans-serif; background: #f0f2f5; padding: 20px; }
h2 { display: inline-block; margin-bottom: 10px; }
#settingsGear { cursor: pointer; font-size: 22px; margin-left: 10px; }
.container { display: flex; gap: 20px; margin-bottom: 10px; }
.column-container { background: #fff; padding: 10px; border-radius: 8px; min-width: 150px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
.column-container h3 { text-align: center; margin-bottom: 10px; cursor: pointer; }
.patient { background: #d0eaff; margin: 5px 0; padding: 5px; border-radius: 4px; cursor: pointer; }
.patient.recent { background: #b6f1b0; }
.operations { display: flex; gap: 10px; margin-top: 20px; }
.op-cell { background: #ffdede; padding: 10px; border-radius: 5px; flex: 1; text-align: center; cursor: grab; }
.switchView { margin-top: 10px; }
.switchView span { margin-right: 10px; font-weight: bold; }
button { padding: 5px 8px; margin-right: 5px; border: none; border-radius: 4px; cursor: pointer; }
button:hover { background-color: #ddd; }
input { padding: 4px; margin-right: 5px; border-radius: 4px; border: 1px solid #ccc; }
.modal-bg { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; }
.modal { background:#fff; padding:20px; border-radius:8px; min-width:250px; }
.modal input { width: 100%; margin-bottom: 10px; }
.modal button { width: 48%; }
</style>
</head>
<body>

<h2>病人录入系统</h2>
<span id="settingsGear">⚙️</span>
<div>
  <input type="text" id="patientName" placeholder="病人姓名">
  <input list="doctorList" id="doctorInput" placeholder="选择或输入医生">
  <datalist id="doctorList"></datalist>
  <button id="addPatientBtn">添加病人</button>
</div>

<h2>病人列表</h2>
<div class="container" id="columnsContainer"></div>

<div class="switchView">
  <span>显示模式:</span>
  <button id="currentBtn">当前在院</button>
  <button id="allBtn">所有病人</button>
</div>

<div class="operations">
  <div class="op-cell" id="dischargeCell">出院</div>
  <div class="op-cell" id="deleteCell">删除</div>
</div>

<!-- 模态框 -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <label id="modalLabel"></label>
    <input type="text" id="modalInput">
    <div style="text-align:right;">
      <button id="modalConfirm">确认</button>
      <button id="modalCancel">取消</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCe5seH8kOkGOfquiUYvFHz2bvcDssWGMs",
  authDomain: "patient-reminder-95c8d.firebaseapp.com",
  databaseURL: "https://patient-reminder-95c8d-default-rtdb.firebaseio.com",
  projectId: "patient-reminder-95c8d",
  storageBucket: "patient-reminder-95c8d.firebasestorage.app",
  messagingSenderId: "726326025491",
  appId: "1:726326025491:web:6b77dce30f7c0f9ddc4ee6"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let patients=[], doctors=[], recentPatientName=null, showAll=false;
let editPatient=null;

// 模态框操作
const modalBg=document.getElementById("modalBg");
const modalInput=document.getElementById("modalInput");
const modalLabel=document.getElementById("modalLabel");
const modalConfirm=document.getElementById("modalConfirm");
const modalCancel=document.getElementById("modalCancel");

function openModal(label,text,callback){
  modalLabel.innerText=label;
  modalInput.value=text;
  modalBg.style.display="flex";
  modalInput.focus();
  const confirmHandler=()=>{ callback(modalInput.value.trim()); closeModal(); };
  modalConfirm.onclick=confirmHandler;
  modalCancel.onclick=()=>{ closeModal(); };
  function closeModal(){ modalBg.style.display="none"; modalConfirm.onclick=null; modalCancel.onclick=null; }
}

// 渲染医生列
function renderColumns(){
  let displayPatients=showAll ? patients : patients.filter(p=>!p.discharge);
  doctors=doctors.filter(doc=>displayPatients.some(p=>p.doctor===doc));
  displayPatients.forEach(p=>{ if(p.row===undefined || p.row===null)p.row=0; });

  const container=document.getElementById("columnsContainer");
  container.innerHTML="";
  doctors.forEach(doc=>{
    const colDiv=document.createElement("div");
    colDiv.className="column-container";
    colDiv.dataset.doctor=doc;

    const header=document.createElement("h3");
    header.innerText=doc;
    header.addEventListener("click",()=>{
      openModal("修改医生姓名",doc,newName=>{
        if(newName && newName!==doc){
          // 修改医生名
          patients.forEach(p=>{ if(p.doctor===doc)p.doctor=newName; });
          const idx=doctors.indexOf(doc); if(idx>-1) doctors[idx]=newName;
          set(ref(db,'patients'),patients);
          set(ref(db,'doctorOrder'),doctors);
          renderColumns();
        }
      });
    });
    colDiv.appendChild(header);

    displayPatients.filter(p=>p.doctor===doc).sort((a,b)=>a.row-b.row)
    .forEach((p,index)=>{
      p.row=index;
      const pDiv=document.createElement("div");
      pDiv.className="patient";
      if(p.name===recentPatientName)pDiv.classList.add("recent");
      if(showAll && p.discharge)pDiv.innerText=p.name+" (已出院)"; else pDiv.innerText=p.name;
      pDiv.draggable=true;
      pDiv.dataset.name=p.name;
      pDiv.dataset.doctor=p.doctor;
      pDiv.dataset.row=p.row;
      // 点击编辑姓名
      pDiv.addEventListener("click",()=>{
        editPatient=p;
        openModal("修改病人姓名",p.name,newName=>{
          if(newName && newName!==p.name){
            p.name=newName;
            recentPatientName=newName;
            set(ref(db,'patients'),patients);
            renderColumns();
          }
        });
      });
      colDiv.appendChild(pDiv);
    });
    container.appendChild(colDiv);
  });
  updateDoctorList();
}

// 更新医生列表
function updateDoctorList(){
  const list=document.getElementById("doctorList");
  list.innerHTML=doctors.map(d=>`<option value="${d}">`).join("");
}

// 添加病人
document.getElementById("addPatientBtn").addEventListener("click",()=>{
  const name=document.getElementById("patientName").value.trim();
  const doctor=document.getElementById("doctorInput").value.trim();
  if(!name || !doctor) return alert("请输入姓名并选择医生");
  if(!doctors.includes(doctor)) doctors.push(doctor);

  const colPatients=patients.filter(p=>p.doctor===doctor && !p.discharge);
  const row=colPatients.length ?? 0;
  const newPatient={name,doctor,row};
  patients.push(newPatient);
  recentPatientName=name;

  updateFirebase();
  document.getElementById("patientName").value="";
  document.getElementById("doctorInput").value="";
  renderColumns();
});

// Firebase 同步
function updateFirebase(){
  set(ref(db,'patients'),patients);
  set(ref(db,'doctorOrder'),doctors);
}

// 实时渲染 Firebase 数据
onValue(ref(db,'patients'),snapshot=>{
  patients=snapshot.val()||[];
  renderColumns();
});
onValue(ref(db,'doctorOrder'),snapshot=>{
  const cloudOrder=snapshot.val();
  if(cloudOrder) doctors=cloudOrder;
  renderColumns();
});

// 设置医生顺序
document.getElementById("settingsGear").addEventListener("click",()=>{
  openModal("设置医生顺序（用 - 分割）",doctors.join("-"),val=>{
    if(val){
      const newOrder=val.split("-").map(d=>d.trim()).filter(d=>d);
      doctors=newOrder;
      set(ref(db,'doctorOrder'),doctors);
      renderColumns();
    }
  });
});

// 切换视图
document.getElementById("currentBtn").addEventListener("click",()=>{ showAll=false; renderColumns(); });
document.getElementById("allBtn").addEventListener("click",()=>{ showAll=true; renderColumns(); });

// 拖拽病人与操作
let dragPatient=null;
document.addEventListener("dragstart",e=>{
  const p=e.target.closest(".patient");
  if(p) dragPatient=p;
});
document.addEventListener("dragover",e=>e.preventDefault());
document.addEventListener("drop",e=>{
  e.preventDefault();
  const targetCol = e.target.closest(".column-container");
  const targetPatient = e.target.closest(".patient");
  const opCell = e.target.closest(".op-cell");

  if(dragPatient && targetCol){
    const targetDoctor=targetCol.dataset.doctor;
    const patientObj=patients.find(p=>p.name===dragPatient.dataset.name);
    if(!patientObj) return;

    if(targetPatient && targetPatient!==dragPatient){
      const targetObj=patients.find(p=>p.name===targetPatient.dataset.name);
      if(targetObj){ const temp=patientObj.row ??0; patientObj.row=targetObj.row ??0; targetObj.row=temp; }
    }else{
      patientObj.doctor=targetDoctor;
      const colPatients=patients.filter(p=>p.doctor===targetDoctor && !p.discharge);
      patientObj.row=colPatients.length ??0;
    }
    updateFirebase();
    dragPatient=null;
    renderColumns();
    return;
  }

  if(dragPatient && opCell){
    const patientIndex=patients.findIndex(p=>p.name===dragPatient.dataset.name);
    if(patientIndex>-1){
      if(opCell.id==="deleteCell"){ patients.splice(patientIndex,1); }
      else if(opCell.id==="dischargeCell"){ patients[patientIndex].discharge=true; }
      updateFirebase();
      dragPatient=null;
      renderColumns();
    }
  }
});
</script>

</body>
</html>
